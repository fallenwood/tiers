(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const N="modulepreload",T=function(u){return"/"+u},L={},k=function(t,e,o){let s=Promise.resolve();if(e&&e.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};var n=l;document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");s=l(e.map(c=>{if(c=T(c),c in L)return;L[c]=!0;const d=c.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":N,d||(h.as="script"),h.crossOrigin="",h.href=c,r&&h.setAttribute("nonce",r),document.head.appendChild(h),d)return new Promise((g,b)=>{h.addEventListener("load",g),h.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return s.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})},x={EQUALS:"equals",GREATER:"greater",GREATER_OR_EQUALS:"greater_or_equals",LESS:"less",LESS_OR_EQUALS:"less_or_equals"},M={[x.EQUALS]:"=",[x.GREATER]:">",[x.GREATER_OR_EQUALS]:"‚â•",[x.LESS]:"<",[x.LESS_OR_EQUALS]:"‚â§"};class R{canvas;ctx;imageCache=new Map;scale=1;offsetX=0;offsetY=0;constructor(t){this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e}clear(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle="#1a1a2e",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.setTransform(this.scale,0,0,this.scale,this.offsetX,this.offsetY),this.ctx.strokeStyle="#2a2a4e",this.ctx.lineWidth=1/this.scale;const t=30,e=this.screenToWorld(0,0),o=this.screenToWorld(this.canvas.width,this.canvas.height),s=Math.floor(e.x/t)*t,i=Math.ceil(o.x/t)*t,n=Math.floor(e.y/t)*t,a=Math.ceil(o.y/t)*t;for(let r=s;r<=i;r+=t)this.ctx.beginPath(),this.ctx.moveTo(r,e.y),this.ctx.lineTo(r,o.y),this.ctx.stroke();for(let r=n;r<=a;r+=t)this.ctx.beginPath(),this.ctx.moveTo(e.x,r),this.ctx.lineTo(o.x,r),this.ctx.stroke()}drawNode(t,e=!1,o=!1){const{x:s,y:i,width:n,height:a,label:r,color:l,imageUrl:c}=t;if(this.ctx.shadowColor="rgba(0, 0, 0, 0.3)",this.ctx.shadowBlur=10,this.ctx.shadowOffsetX=3,this.ctx.shadowOffsetY=3,this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.roundRect(s,i,n,a,8),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,e&&(this.ctx.strokeStyle="#00ff88",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.roundRect(s-2,i-2,n+4,a+4,10),this.ctx.stroke()),o&&(this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.roundRect(s-4,i-4,n+8,a+8,12),this.ctx.stroke(),this.ctx.setLineDash([])),c){const f=s+(n-64)/2,h=i+8;let g=this.imageCache.get(c);g?g.complete&&g.naturalHeight!==0&&this.drawImageInNode(g,f,h,64):(g=new Image,g.crossOrigin="anonymous",g.src=c,this.imageCache.set(c,g),g.onload=()=>{this.drawImageInNode(g,f,h,64)}),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 11px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="top";const b=i+h+64+8,m=n-16;this.drawMultilineText(r,s+n/2,b,m,3)}else{this.ctx.fillStyle="#ffffff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const d=n-16;this.drawMultilineText(r,s+n/2,i+a/2,d,3,!0)}this.drawConnectionPoint(s,i+a/2),this.drawConnectionPoint(s+n,i+a/2),this.drawConnectionPoint(s+n/2,i),this.drawConnectionPoint(s+n/2,i+a)}drawMultilineText(t,e,o,s,i,n=!1){const a=t.split(" "),r=[];let l="";for(const g of a){const b=l?`${l} ${g}`:g;this.ctx.measureText(b).width>s&&l?(r.push(l),l=g):l=b}l&&r.push(l);const c=r.slice(0,i);r.length>i&&(c[i-1]=c[i-1]+"...");const d=14,f=c.length*d,h=n?o-f/2+d/2:o;c.forEach((g,b)=>{this.ctx.fillText(g,e,h+b*d,s)})}drawImageInNode(t,e,o,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.roundRect(e,o,s,s,6),this.ctx.clip(),this.ctx.drawImage(t,e,o,s,s),this.ctx.restore(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.roundRect(e,o,s,s,6),this.ctx.stroke()}drawConnectionPoint(t,e){this.ctx.fillStyle="#ffffff",this.ctx.beginPath(),this.ctx.arc(t,e,5,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#333",this.ctx.lineWidth=2,this.ctx.stroke()}drawConnection(t,e,o,s=!1){const i={x:t.x+t.width/2,y:t.y+t.height/2},n={x:e.x+e.width/2,y:e.y+e.height/2},a=this.getEdgePoint(t,n),r=this.getEdgePoint(e,i),l=(a.x+r.x)/2,c=(a.y+r.y)/2,d=50,f=r.x-a.x,h=r.y-a.y,g=Math.sqrt(f*f+h*h),b=-h/g,m=f/g,p=l+b*d*.3,w=c+m*d*.3;this.ctx.strokeStyle=s?"#00ff88":"#6c5ce7",this.ctx.lineWidth=s?4:3,this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y),this.ctx.quadraticCurveTo(p,w,r.x,r.y),this.ctx.stroke(),this.drawArrow(p,w,r.x,r.y,s?"#00ff88":"#6c5ce7");const v=M[o.relationship];this.ctx.fillStyle="#1a1a2e",this.ctx.beginPath(),this.ctx.arc(l,c,16,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=s?"#00ff88":"#6c5ce7",this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(v,l,c)}getEdgePoint(t,e){const o=t.x+t.width/2,s=t.y+t.height/2,i=e.x-o,n=e.y-s,a=Math.abs(i),r=Math.abs(n),l=t.width/2,c=t.height/2;if(a*c>r*l){const d=i>0?1:-1;return{x:o+d*l,y:s+n*l/a}}else{const d=n>0?1:-1;return{x:o+i*c/r,y:s+d*c}}}drawArrow(t,e,o,s,i){const a=Math.atan2(s-e,o-t);this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.moveTo(o,s),this.ctx.lineTo(o-12*Math.cos(a-Math.PI/6),s-12*Math.sin(a-Math.PI/6)),this.ctx.lineTo(o-12*Math.cos(a+Math.PI/6),s-12*Math.sin(a+Math.PI/6)),this.ctx.closePath(),this.ctx.fill()}drawConnectionPreview(t,e,o){const s=this.getEdgePoint(t,{x:e,y:o});this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.setLineDash([10,5]),this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(e,o),this.ctx.stroke(),this.ctx.setLineDash([])}resize(t,e){this.canvas.width=t,this.canvas.height=e}setScale(t,e,o){const s=(e-this.offsetX)/this.scale,i=(o-this.offsetY)/this.scale;this.scale=Math.max(.1,Math.min(5,t)),this.offsetX=e-s*this.scale,this.offsetY=o-i*this.scale}getScale(){return this.scale}pan(t,e){this.offsetX+=t,this.offsetY+=e}screenToWorld(t,e){return{x:(t-this.offsetX)/this.scale,y:(e-this.offsetY)/this.scale}}worldToScreen(t,e){return{x:t*this.scale+this.offsetX,y:e*this.scale+this.offsetY}}}const S="node-graph-editor-state";function P(u){try{localStorage.setItem(S,JSON.stringify(u))}catch(t){console.error("Failed to save state to localStorage:",t)}}function I(){try{const u=localStorage.getItem(S);if(u)return JSON.parse(u)}catch(u){console.error("Failed to load state from localStorage:",u)}return null}function B(){try{localStorage.removeItem(S)}catch(u){console.error("Failed to clear localStorage:",u)}}const E=["#e74c3c","#3498db","#2ecc71","#9b59b6","#f39c12","#1abc9c","#e91e63","#00bcd4"];class A{canvas;renderer;nodes=[];toolbarNodes=[];connections=[];selectedNode=null;isDragging=!1;dragOffset={x:0,y:0};mousePos={x:0,y:0};nodeCounter=0;selectedConnection=null;isPanning=!1;panStart={x:0,y:0};onStateChange=null;onToolbarChange=null;onValidationChange=null;constructor(t){this.canvas=t,this.renderer=new R(t),this.setupEventListeners(),this.loadFromStorage(),requestAnimationFrame(()=>{this.resizeCanvas()}),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.parentElement;if(t){const e=t.getBoundingClientRect(),o=e.width||800,s=e.height||600;this.renderer.resize(o,s),this.render()}}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",this.handleContextMenu.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this))}getMousePosition(t){const e=this.canvas.getBoundingClientRect(),o=this.canvas.width/e.width,s=this.canvas.height/e.height,i=(t.clientX-e.left)*o,n=(t.clientY-e.top)*s;return this.renderer.screenToWorld(i,n)}handleMouseDown(t){if(t.button!==0)return;const e=this.canvas.getBoundingClientRect(),o=this.canvas.width/e.width,s=this.canvas.height/e.height,i=(t.clientX-e.left)*o,n=(t.clientY-e.top)*s,{x:a,y:r}=this.getMousePosition(t),l=this.getNodeAtPosition(a,r),c=this.getConnectionAtPosition(a,r);if(c&&!l){this.selectedConnection=c,this.selectedNode=null,this.render();return}if(l){if(l.isInToolbar)return;if(t.shiftKey&&this.selectedNode&&this.selectedNode.id!==l.id){this.showConnectionDialog(this.selectedNode,l),this.render();return}this.selectedNode=l,this.selectedConnection=null,this.isDragging=!0,this.dragOffset={x:a-l.x,y:r-l.y}}else this.selectedNode=null,this.selectedConnection=null,this.isPanning=!0,this.panStart={x:i,y:n},this.canvas.style.cursor="grabbing";this.render()}handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),o=this.canvas.width/e.width,s=this.canvas.height/e.height,i=(t.clientX-e.left)*o,n=(t.clientY-e.top)*s;if(this.isPanning){const l=i-this.panStart.x,c=n-this.panStart.y;this.renderer.pan(l,c),this.panStart={x:i,y:n},this.render();return}const{x:a,y:r}=this.getMousePosition(t);this.mousePos.x=a,this.mousePos.y=r,this.isDragging&&this.selectedNode&&(this.selectedNode.x=this.mousePos.x-this.dragOffset.x,this.selectedNode.y=this.mousePos.y-this.dragOffset.y,this.render())}handleMouseUp(){this.isPanning&&(this.isPanning=!1,this.canvas.style.cursor="default"),this.isDragging&&(this.isDragging=!1,this.saveToStorage())}handleDoubleClick(t){const{x:e,y:o}=this.getMousePosition(t),s=this.getNodeAtPosition(e,o);if(s){const i=prompt("Enter new label:",s.label);i!==null&&i.trim()!==""&&(s.label=i.trim(),this.saveToStorage(),this.render())}else this.addNode(e-60,o-25)}handleContextMenu(t){t.preventDefault();const{x:e,y:o}=this.getMousePosition(t),s=this.getNodeAtPosition(e,o);if(s&&!s.isInToolbar){confirm(`Move "${s.label}" back to library?
Click Cancel to keep it on canvas.`)&&this.moveNodeToToolbar(s);return}const i=this.getConnectionAtPosition(e,o);i&&!s&&confirm("Delete this connection?")&&this.deleteConnection(i.id)}handleKeyDown(t){t.key==="Delete"||t.key==="Backspace"?this.selectedNode?this.moveNodeToToolbar(this.selectedNode):this.selectedConnection&&this.deleteConnection(this.selectedConnection.id):t.key==="Escape"&&(this.selectedNode=null,this.selectedConnection=null,this.render())}handleWheel(t){t.preventDefault();const e=this.canvas.getBoundingClientRect(),o=this.canvas.width/e.width,s=this.canvas.height/e.height,i=(t.clientX-e.left)*o,n=(t.clientY-e.top)*s,a=t.deltaY>0?.9:1.1,l=this.renderer.getScale()*a;this.renderer.setScale(l,i,n),this.render()}getNodeAtPosition(t,e){for(let o=this.nodes.length-1;o>=0;o--){const s=this.nodes[o];if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return s}return null}getConnectionAtPosition(t,e){for(const o of this.connections){const s=this.nodes.find(l=>l.id===o.fromNodeId),i=this.nodes.find(l=>l.id===o.toNodeId);if(!s||!i)continue;const n=(s.x+s.width/2+i.x+i.width/2)/2,a=(s.y+s.height/2+i.y+i.height/2)/2;if(Math.sqrt((t-n)**2+(e-a)**2)<20)return o}return null}async showConnectionDialog(t,e){console.log("showConnectionDialog called from:",t.label,"to:",e.label);const o=this.connections.find(s=>s.fromNodeId===t.id&&s.toNodeId===e.id||s.fromNodeId===e.id&&s.toNodeId===t.id);if(o)console.log("Existing connection found, showing selector"),await this.showRelationshipSelector(o);else{console.log("No existing connection, prompting for relationship");const s=await this.promptRelationship();console.log("User selected relationship:",s),s?this.addConnection(t.id,e.id,s):console.log("No relationship selected (user cancelled)")}}promptRelationship(){return console.log("promptRelationship called"),new Promise(t=>{const e=document.getElementById("relationshipModal");if(!e){console.error("Modal not found"),t(null);return}e.classList.remove("hidden"),e.classList.add("flex");const o=a=>{const l=a.target.closest(".rel-option");if(l){const c=l.dataset.type;console.log("Selected relationship:",c),i(),t(c)}},s=()=>{console.log("Cancelled relationship selection"),i(),t(null)},i=()=>{e.classList.add("hidden"),e.classList.remove("flex"),e.removeEventListener("click",o),document.getElementById("cancelRelationship")?.removeEventListener("click",s)};e.addEventListener("click",o),document.getElementById("cancelRelationship")?.addEventListener("click",s)})}async showRelationshipSelector(t){const e=await this.promptRelationship();e&&(t.relationship=e,this.saveToStorage(),this.render())}addNode(t,e){this.nodeCounter++;const o={id:`node-${Date.now()}-${this.nodeCounter}`,x:t??100+this.nodes.length%5*150,y:e??100+Math.floor(this.nodes.length/5)*100,width:120,height:50,label:`Node ${this.nodeCounter}`,color:E[(this.nodeCounter-1)%E.length]};return this.nodes.push(o),this.saveToStorage(),this.render(),o}async loadFromFile(t){try{const e=await t.text(),o=t.name.toLowerCase();let s=[];if(o.endsWith(".json")){const i=JSON.parse(e);if(Array.isArray(i))s=i.map(n=>{if(typeof n=="string")return{label:n};if(typeof n=="object"&&n!==null){const a=n.text||n.label||n.name||n.value||JSON.stringify(n),r=n.image||n.imageUrl||n.img||n.picture||n.thumbnail||n.url;return{label:a,imageUrl:r}}return{label:String(n)}});else throw new Error("JSON file must contain an array")}else s=e.split(`
`).map(i=>i.trim()).filter(i=>i.length>0).map(i=>({label:i}));this.toolbarNodes=[],s.forEach(i=>{this.nodeCounter++;const n=!!i.imageUrl,a={id:`toolbar-${Date.now()}-${this.nodeCounter}`,x:0,y:0,width:120,height:n?120:50,label:i.label,color:E[(this.nodeCounter-1)%E.length],isInToolbar:!0,imageUrl:i.imageUrl};this.toolbarNodes.push(a)}),this.saveToStorage(),this.onToolbarChange?.(),this.render(),console.log(`Loaded ${s.length} nodes to toolbar from ${t.name}`)}catch(e){console.error("Error loading file:",e),alert(`Error loading file: ${e instanceof Error?e.message:"Unknown error"}`)}}deleteNode(t){const e=this.nodes.find(o=>o.id===t);if(this.nodes=this.nodes.filter(o=>o.id!==t),this.connections=this.connections.filter(o=>o.fromNodeId!==t&&o.toNodeId!==t),this.selectedNode=null,e){const o={...e,id:`toolbar-${Date.now()}-${++this.nodeCounter}`,x:0,y:0,isInToolbar:!0};this.toolbarNodes.push(o),this.onToolbarChange?.()}this.saveToStorage(),this.render()}moveNodeToCanvas(t,e,o){const s={...t,id:`node-${Date.now()}-${++this.nodeCounter}`,x:e-t.width/2,y:o-t.height/2,isInToolbar:!1};this.nodes.push(s),this.toolbarNodes=this.toolbarNodes.filter(i=>i.id!==t.id),this.onToolbarChange?.(),this.saveToStorage(),this.render()}moveNodeToToolbar(t){this.nodes=this.nodes.filter(o=>o.id!==t.id),this.connections=this.connections.filter(o=>o.fromNodeId!==t.id&&o.toNodeId!==t.id);const e={...t,id:`toolbar-${Date.now()}-${++this.nodeCounter}`,x:0,y:0,isInToolbar:!0};this.toolbarNodes.push(e),this.onToolbarChange?.(),this.selectedNode=null,this.saveToStorage(),this.render()}getToolbarNodes(){return this.toolbarNodes}addConnection(t,e,o){const s={id:`conn-${Date.now()}`,fromNodeId:t,toNodeId:e,relationship:o};return this.connections.push(s),this.saveToStorage(),this.render(),s}deleteConnection(t){this.connections=this.connections.filter(e=>e.id!==t),this.selectedConnection=null,this.saveToStorage(),this.render()}saveToStorage(){const t={nodes:this.nodes,connections:this.connections,toolbarNodes:this.toolbarNodes};P(t),this.onStateChange?.();const e=this.validate();this.onValidationChange?.(e)}loadFromStorage(){const t=I();if(t){this.nodes=t.nodes,this.connections=t.connections,this.toolbarNodes=t.toolbarNodes||[],this.nodeCounter=this.nodes.length+this.toolbarNodes.length,this.onToolbarChange?.();const e=this.validate();this.onValidationChange?.(e)}}getConnectionsInfo(){return this.connections.map(t=>{const e=this.nodes.find(i=>i.id===t.fromNodeId),o=this.nodes.find(i=>i.id===t.toNodeId),s={equals:"=",greater:">",greater_or_equals:"‚â•",less:"<",less_or_equals:"‚â§"};return{fromLabel:e?.label||"Unknown",toLabel:o?.label||"Unknown",symbol:s[t.relationship]||"?"}})}areNodesConnected(t,e){return this.connections.some(o=>o.fromNodeId===t&&o.toNodeId===e||o.fromNodeId===e&&o.toNodeId===t)}clearAll(){confirm("Are you sure you want to clear all nodes and connections?")&&(this.nodes.forEach(t=>{t.isInToolbar||(t.isInToolbar=!0,this.toolbarNodes.push(t))}),this.nodes=[],this.connections=[],this.selectedNode=null,this.selectedConnection=null,B(),this.saveToStorage(),this.onStateChange?.(),this.onToolbarChange?.(),this.render())}clearToolbar(){this.toolbarNodes=[],this.saveToStorage(),this.onToolbarChange?.()}validate(){const t=[];this.nodes.length>1&&(this.isGraphConnected()||t.push("Not all nodes are connected. Every node must be reachable from every other node."));const e=this.checkForContradictoryCycles();return e&&t.push(e),{valid:t.length===0,errors:t}}isGraphConnected(){if(this.nodes.length===0)return!0;const t=new Map;this.nodes.forEach(s=>t.set(s.id,new Set)),this.connections.forEach(s=>{t.get(s.fromNodeId)?.add(s.toNodeId),t.get(s.toNodeId)?.add(s.fromNodeId)});const e=new Set,o=[this.nodes[0].id];for(e.add(this.nodes[0].id);o.length>0;){const s=o.shift(),i=t.get(s)||new Set;for(const n of i)e.has(n)||(e.add(n),o.push(n))}return e.size===this.nodes.length}checkForContradictoryCycles(){const t=new Map,e=new Map;this.nodes.forEach(c=>{t.set(c.id,[]),e.set(c.id,[])}),this.connections.forEach(c=>{const{fromNodeId:d,toNodeId:f,relationship:h}=c;h===x.LESS?t.get(d)?.push(f):h===x.GREATER?t.get(f)?.push(d):h===x.LESS_OR_EQUALS?e.get(d)?.push(f):h===x.GREATER_OR_EQUALS?e.get(f)?.push(d):h===x.EQUALS&&(e.get(d)?.push(f),e.get(f)?.push(d))});const o=0,s=1,i=2,n=new Map,a=[],r=[];this.nodes.forEach(c=>n.set(c.id,o));const l=(c,d)=>{n.set(c,s),a.push(c),r.push(d);const f=t.get(c)||[];for(const g of f){const b=n.get(g);if(b===s){const m=a.indexOf(g),p=a.slice(m);return p.push(g),`Contradictory cycle detected: ${p.map(v=>this.nodes.find(C=>C.id===v)?.label||"Unknown").join(" ‚â§ ")} (with at least one strict < or >). This creates a logical impossibility.`}else if(b===o){const m=l(g,!0);if(m)return m}}const h=e.get(c)||[];for(const g of h){const b=n.get(g);if(b===s){const m=a.indexOf(g);if(r.slice(m).some(p=>p)){const p=a.slice(m);return p.push(g),`Contradictory cycle detected: ${p.map(v=>this.nodes.find(C=>C.id===v)?.label||"Unknown").join(" ‚â§ ")} (with at least one strict < or >). This creates a logical impossibility.`}}else if(b===o){const m=l(g,d);if(m)return m}}return n.set(c,i),a.pop(),r.pop(),null};for(const c of this.nodes)if(n.get(c.id)===o){const d=l(c.id,!1);if(d)return d}return null}generateRanking(){if(this.nodes.length===0)return{success:!1,error:"No nodes to rank"};if(!this.validate().valid)return{success:!1,error:"Graph must be valid before generating ranking. Fix validation errors first."};const e=new Map,o=new Map;this.nodes.forEach(c=>{e.set(c.id,new Set),o.set(c.id,new Set)}),this.connections.forEach(c=>{const{fromNodeId:d,toNodeId:f,relationship:h}=c;h===x.GREATER?e.get(d)?.add(f):h===x.LESS?e.get(f)?.add(d):h===x.GREATER_OR_EQUALS?(e.get(d)?.add(f),o.get(d)?.add(f)):h===x.LESS_OR_EQUALS?(e.get(f)?.add(d),o.get(f)?.add(d)):h===x.EQUALS&&(o.get(d)?.add(f),o.get(f)?.add(d))});const s=this.findStronglyConnectedComponents(o),i=new Map,n=new Map;s.forEach((c,d)=>{i.set(d,new Set),c.forEach(f=>n.set(f,d))}),this.nodes.forEach(c=>{const d=n.get(c.id);e.get(c.id)?.forEach(f=>{const h=n.get(f);d!==h&&i.get(d)?.add(h)})});const a=new Map;i.forEach((c,d)=>a.set(d,0)),i.forEach(c=>{c.forEach(d=>{a.set(d,(a.get(d)||0)+1)})});const r=[],l=[];for(a.forEach((c,d)=>{c===0&&l.push(d)});l.length>0;){const c=[...l];l.length=0;const d=[];c.forEach(f=>{s[f].forEach(h=>{const g=this.nodes.find(b=>b.id===h);g&&d.push(g.label)})}),r.push(d),c.forEach(f=>{i.get(f)?.forEach(h=>{const g=(a.get(h)||0)-1;a.set(h,g),g===0&&l.push(h)})})}return{success:!0,ranks:r}}findStronglyConnectedComponents(t){const e=new Map,o=new Map,s=new Map,i=[],n=[];let a=0;const r=l=>{if(e.set(l,a),o.set(l,a),a++,i.push(l),s.set(l,!0),t.get(l)?.forEach(c=>{e.has(c)?s.get(c)&&o.set(l,Math.min(o.get(l),e.get(c))):(r(c),o.set(l,Math.min(o.get(l),o.get(c))))}),o.get(l)===e.get(l)){const c=[];let d;do d=i.pop(),s.set(d,!1),c.push(d);while(d!==l);n.push(c)}};return this.nodes.forEach(l=>{e.has(l.id)||r(l.id)}),n}render(){this.renderer.clear();for(const t of this.connections){const e=this.nodes.find(s=>s.id===t.fromNodeId),o=this.nodes.find(s=>s.id===t.toNodeId);e&&o&&this.renderer.drawConnection(e,o,t,this.selectedConnection?.id===t.id)}for(const t of this.nodes)this.renderer.drawNode(t,this.selectedNode?.id===t.id,!1);this.updateStatusBar()}updateStatusBar(){const t=document.getElementById("statusBar");t&&(this.selectedNode?(t.textContent=`Selected: "${this.selectedNode.label}" - Shift+Click another node to create connection`,t.classList.remove("hidden"),t.classList.add("flex")):(t.classList.add("hidden"),t.classList.remove("flex")))}}console.log("Main.ts loaded");document.querySelector("#app").innerHTML=`
  <div class="flex flex-col h-screen bg-base-300">
    <header class="flex justify-between items-center px-8 py-4 bg-gradient-to-r from-base-100 to-base-200 border-b border-base-content/10 shadow-lg">
      <h1 class="text-2xl font-semibold text-base-content">Node Graph Editor</h1>
      <div class="flex gap-3">
        <button id="loadFileBtn" class="btn btn-primary btn-sm gap-2">
          <span class="text-lg">üìÅ</span> Load from File
        </button>
        <button id="generateRankingBtn" class="btn btn-accent btn-sm gap-2">
          <span class="text-lg">üìä</span> Generate Ranking
        </button>
        <button id="validateBtn" class="btn btn-secondary btn-sm gap-2">
          <span class="text-lg">‚úì</span> Validate
        </button>
        <button id="clearBtn" class="btn btn-error btn-sm gap-2">
          <span class="text-lg">üóë</span> Clear All
        </button>
      </div>
      <input type="file" id="fileInput" accept=".txt,.json" class="hidden">
    </header>
    <main class="flex flex-1 overflow-hidden">
      <div class="w-52 p-4 bg-gradient-to-b from-base-100 to-base-200 border-r border-base-content/10 overflow-y-auto flex flex-col">
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-base-content/20">
          <h3 class="text-sm font-semibold text-primary">Node Library</h3>
          <button id="clearLibraryBtn" class="text-xs px-2 py-1 bg-error/20 hover:bg-error/30 text-error rounded transition-colors" title="Clear Library">‚úï</button>
        </div>
        <div id="toolbarNodes" class="flex flex-col gap-2"></div>
      </div>
      <div class="flex-1 relative overflow-hidden min-h-0">
        <canvas id="graphCanvas"></canvas>
        <div id="statusBar" class="hidden absolute bottom-0 left-0 right-0 px-4 py-3 bg-base-100/95 border-t border-base-content/10 text-base-content text-sm text-center"></div>
        <div id="relationshipModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
          <div class="bg-gradient-to-b from-base-100 to-base-200 p-8 rounded-xl shadow-2xl max-w-md w-11/12">
            <h3 class="text-xl font-semibold text-base-content mb-6 text-center">Select Relationship Type</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
              <button class="rel-option flex flex-col items-center gap-2 p-4 bg-base-300 border-2 border-transparent rounded-lg cursor-pointer transition-all hover:bg-base-300/70 hover:border-primary hover:-translate-y-0.5" data-type="equals">
                <span class="text-3xl font-semibold text-base-content">=</span>
                <span class="text-sm text-base-content/70">Equals</span>
              </button>
              <button class="rel-option flex flex-col items-center gap-2 p-4 bg-base-300 border-2 border-transparent rounded-lg cursor-pointer transition-all hover:bg-base-300/70 hover:border-primary hover:-translate-y-0.5" data-type="greater">
                <span class="text-3xl font-semibold text-base-content">&gt;</span>
                <span class="text-sm text-base-content/70">Greater</span>
              </button>
              <button class="rel-option flex flex-col items-center gap-2 p-4 bg-base-300 border-2 border-transparent rounded-lg cursor-pointer transition-all hover:bg-base-300/70 hover:border-primary hover:-translate-y-0.5" data-type="greater_or_equals">
                <span class="text-3xl font-semibold text-base-content">‚â•</span>
                <span class="text-sm text-base-content/70">Greater or Equals</span>
              </button>
              <button class="rel-option flex flex-col items-center gap-2 p-4 bg-base-300 border-2 border-transparent rounded-lg cursor-pointer transition-all hover:bg-base-300/70 hover:border-primary hover:-translate-y-0.5" data-type="less">
                <span class="text-3xl font-semibold text-base-content">&lt;</span>
                <span class="text-sm text-base-content/70">Less</span>
              </button>
              <button class="rel-option flex flex-col items-center gap-2 p-4 bg-base-300 border-2 border-transparent rounded-lg cursor-pointer transition-all hover:bg-base-300/70 hover:border-primary hover:-translate-y-0.5" data-type="less_or_equals">
                <span class="text-3xl font-semibold text-base-content">‚â§</span>
                <span class="text-sm text-base-content/70">Less or Equals</span>
              </button>
            </div>
            <button id="cancelRelationship" class="btn btn-error w-full">Cancel</button>
          </div>
        </div>
        <div id="rankingModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
          <div class="p-8 rounded-xl shadow-2xl max-w-2xl w-11/12 max-h-[80vh] overflow-y-auto" style="background: linear-gradient(to bottom, #1a1a2e, #16213e);">
            <h3 class="text-2xl font-semibold mb-6 text-center" style="color: #ffffff;">Ranking Results</h3>
            <div id="rankingModalContent" class="mb-6"></div>
            <div class="flex gap-3">
              <button id="saveRankingImage" class="btn btn-primary flex-1">üíæ Save as Image</button>
              <button id="closeRankingModal" class="btn btn-secondary flex-1">Close</button>
            </div>
          </div>
        </div>
      </div>
      <aside class="w-72 p-6 bg-gradient-to-b from-base-100 to-base-200 border-l border-base-content/10 overflow-y-auto">
        <h3 class="text-base font-semibold text-primary mb-3 pb-2 border-b border-base-content/20">Instructions</h3>
        <ul class="list-none mb-6">
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Load from File:</strong> Upload .txt (one node per line) or .json (array of items) to Node Library</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Add to Canvas:</strong> Drag nodes from Node Library to canvas (removes from library)</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Create Node:</strong> Double-click on canvas</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Move Node:</strong> Click and drag</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Connect Nodes:</strong> Select a node, then Shift+Click another node</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Rename Node:</strong> Double-click on node</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Return to Library:</strong> Right-click node or press Delete/Backspace</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Delete Connection:</strong> Right-click on connection or select and press Delete</li>
          <li class="text-sm text-base-content/70 py-1.5 leading-snug"><strong class="text-base-content font-medium">Cancel:</strong> Press Escape</li>
        </ul>
        <h3 class="text-base font-semibold text-primary mb-3 pb-2 border-b border-base-content/20">Relationships</h3>
        <div class="flex flex-col gap-2 mb-6">
          <span class="flex items-center gap-3 text-sm text-base-content/70">
            <code class="inline-flex items-center justify-center w-7 h-7 bg-base-300 rounded-md text-base font-semibold text-base-content">=</code> Equals
          </span>
          <span class="flex items-center gap-3 text-sm text-base-content/70">
            <code class="inline-flex items-center justify-center w-7 h-7 bg-base-300 rounded-md text-base font-semibold text-base-content">&gt;</code> Greater
          </span>
          <span class="flex items-center gap-3 text-sm text-base-content/70">
            <code class="inline-flex items-center justify-center w-7 h-7 bg-base-300 rounded-md text-base font-semibold text-base-content">‚â•</code> Greater or Equals
          </span>
          <span class="flex items-center gap-3 text-sm text-base-content/70">
            <code class="inline-flex items-center justify-center w-7 h-7 bg-base-300 rounded-md text-base font-semibold text-base-content">&lt;</code> Less
          </span>
          <span class="flex items-center gap-3 text-sm text-base-content/70">
            <code class="inline-flex items-center justify-center w-7 h-7 bg-base-300 rounded-md text-base font-semibold text-base-content">‚â§</code> Less or Equals
          </span>
        </div>
        <h3 class="text-base font-semibold text-primary mb-3 pb-2 border-b border-base-content/20">Connections</h3>
        <div id="connectionsList" class="mb-6">
          <p class="text-sm text-base-content/50 italic">No connections yet</p>
        </div>
        <h3 class="text-base font-semibold text-primary mb-3 pb-2 border-b border-base-content/20">Validation</h3>
        <div id="validationStatus">
          <p class="text-sm text-base-content/50 italic">Validation updates automatically</p>
        </div>
      </aside>
    </main>
  </div>
`;console.log("HTML injected");const y=document.getElementById("graphCanvas");console.log("Canvas element:",y);if(y){const u=new A(y);console.log("Editor created"),u.render(),document.getElementById("loadFileBtn")?.addEventListener("click",()=>{const n=document.getElementById("fileInput");n&&n.click()}),document.getElementById("fileInput")?.addEventListener("change",async n=>{const a=n.target,r=a.files?.[0];r&&(await u.loadFromFile(r),t(),s(),a.value="")}),document.getElementById("validateBtn")?.addEventListener("click",()=>{const n=u.validate();e(n)}),document.getElementById("generateRankingBtn")?.addEventListener("click",()=>{const n=u.generateRanking();o(n)}),document.getElementById("clearBtn")?.addEventListener("click",()=>{u.clearAll(),t()}),document.getElementById("clearLibraryBtn")?.addEventListener("click",()=>{confirm("Clear all nodes from library?")&&(u.clearToolbar(),s())});const t=()=>{const n=document.getElementById("connectionsList");if(!n)return;const a=u.getConnectionsInfo();a.length===0?n.innerHTML='<p class="text-base-content/50 text-sm italic">No connections yet</p>':n.innerHTML=a.map(r=>`<div class="flex items-center gap-2 p-2 bg-base-300 rounded-md mb-2 text-sm">
          <span class="text-base-content font-medium">${r.fromLabel}</span>
          <span class="text-primary font-semibold text-base">${r.symbol}</span>
          <span class="text-base-content font-medium">${r.toLabel}</span>
        </div>`).join("")},e=n=>{const a=document.getElementById("validationStatus");if(a)if(n.valid)a.innerHTML='<p class="text-secondary text-sm font-medium px-3 py-2 bg-secondary/10 rounded-md border-l-4 border-secondary">‚úì Graph is valid!</p>';else{const r=n.errors.map(l=>`<li class="py-1.5 px-3 bg-error/5 rounded text-error/90">${l}</li>`).join("");a.innerHTML=`<p class="text-error text-sm font-medium px-3 py-2 bg-error/10 rounded-md border-l-4 border-error mb-2">‚úó Validation failed:</p><ul class="list-none mt-2 space-y-1">${r}</ul>`}},o=n=>{const a=document.getElementById("rankingModal"),r=document.getElementById("rankingModalContent");if(!(!a||!r)){if(!n.success)r.innerHTML=`<p class="text-error text-base font-medium px-4 py-3 bg-error/10 rounded-lg border-l-4 border-error">${n.error||"Failed to generate ranking"}</p>`;else if(!n.ranks||n.ranks.length===0)r.innerHTML='<p class="text-base-content/50 text-base italic text-center">No nodes to rank</p>';else{const l=["S","A","B","C","D","E","F"],c=["#ff7f7f","#ffbf7f","#ffdf7f","#bfff7f","#999999","#7f7f7f","#5f5f5f"],d=n.ranks.map((f,h)=>{const g=h<l.length?l[h]:(h+1).toString(),b=h<c.length?c[h]:"#666666",m=f.map(p=>`<div class="inline-flex items-center justify-center px-4 py-3 rounded text-base font-semibold" style="background-color: #2a2a3e; color: #ffffff; min-width: 100px; border: 2px solid #3a3a4e;">${p}</div>`).join("");return`<div class="flex items-stretch mb-2" style="background-color: #1a1a2a; border-radius: 4px; overflow: hidden;">
          <div class="flex items-center justify-center font-black text-3xl" style="background-color: ${b}; color: #000000; width: 80px; min-height: 80px;">
            ${g}
          </div>
          <div class="flex items-center flex-wrap gap-2 p-3 flex-1" style="background-color: #0f0f1a;">
            ${m}
          </div>
        </div>`}).join("");r.innerHTML=`<div class="space-y-2" style="background-color: #0a0a0f; padding: 20px; border-radius: 8px;">${d}</div>`}a.classList.remove("hidden"),a.classList.add("flex")}};document.getElementById("closeRankingModal")?.addEventListener("click",()=>{const n=document.getElementById("rankingModal");n&&(n.classList.add("hidden"),n.classList.remove("flex"))}),document.getElementById("saveRankingImage")?.addEventListener("click",async()=>{const n=document.getElementById("rankingModalContent");if(n)try{const a=(await k(async()=>{const{default:l}=await import("./html2canvas.esm-DXEQVQnt.js");return{default:l}},[])).default;(await a(n,{backgroundColor:"#1a1a2e",scale:2})).toBlob(l=>{if(l){const c=URL.createObjectURL(l),d=document.createElement("a");d.href=c,d.download=`ranking-${new Date().getTime()}.png`,d.click(),URL.revokeObjectURL(c)}})}catch(a){console.error("Failed to save image:",a),alert("Failed to save image. Please try again.")}});const s=()=>{const n=document.getElementById("toolbarNodes");if(!n)return;const a=u.getToolbarNodes();a.length===0?n.innerHTML='<p class="text-base-content/50 text-sm text-center italic">No nodes loaded</p>':(n.innerHTML=a.map(r=>{const l=!!r.imageUrl,c=l?`<img src="${r.imageUrl}" alt="${r.label}" class="w-16 h-16 object-cover rounded mb-2 mx-auto" crossorigin="anonymous" />`:"";return`<div class="toolbar-node px-3 ${l?"py-3":"py-2"} rounded-lg text-sm text-white cursor-grab text-center select-none transition-all border-2 border-transparent hover:translate-x-1 hover:border-white/20 flex flex-col items-center" 
              data-node-id="${r.id}"
              data-node-label="${r.label}"
              data-node-color="${r.color}"
              data-node-image="${r.imageUrl||""}"
              data-node-height="${r.height}"
              draggable="true"
              style="background-color: ${r.color};">
          ${c}
          <span class="text-xs font-medium">${r.label}</span>
        </div>`}).join(""),n.querySelectorAll(".toolbar-node").forEach(r=>{r.addEventListener("dragstart",l=>{const c=l,d=l.target,f=d.dataset.nodeId,h=d.dataset.nodeLabel,g=d.dataset.nodeColor,b=d.dataset.nodeImage,m=d.dataset.nodeHeight;c.dataTransfer&&f&&h&&g&&(c.dataTransfer.effectAllowed="copy",c.dataTransfer.setData("text/plain",JSON.stringify({id:f,label:h,color:g,imageUrl:b||void 0,height:parseInt(m||"50"),fromToolbar:!0})))})}))};y.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="copy")}),y.addEventListener("drop",n=>{n.preventDefault();const a=n.dataTransfer?.getData("text/plain");if(a)try{const r=JSON.parse(a);if(r.fromToolbar){const l=y.getBoundingClientRect(),c=y.width/l.width,d=y.height/l.height,f=(n.clientX-l.left)*c,h=(n.clientY-l.top)*d,g=u.getToolbarNodes().find(b=>b.id===r.id);g&&(u.moveNodeToCanvas(g,f,h),t())}}catch(r){console.error("Error handling drop:",r)}});const i=document.getElementById("toolbarNodes");i&&(i.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="move")}),i.addEventListener("drop",n=>{n.preventDefault()})),y.addEventListener("dragstart",()=>{}),u.onStateChange=t,u.onToolbarChange=s,u.onValidationChange=e,t(),s()}else console.error("Canvas element not found!");
